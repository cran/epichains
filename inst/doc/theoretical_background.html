<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Sebastian Funk and James Azam" />


<title>Theoretical background for epichains</title>

<style type="text/css">detaiks.chunk-details > summary.chunk-summary {
text-align: right;
}
details.chunk-details[open] > summary.chunk-summary::after {
content: "Hide";
}
details.chunk-details[open] > summary.chunk-summary > span.chunk-summary-text {
display: none;
}
</style>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>






<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
margin-bottom: 0em;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Theoretical background for epichains</h1>
<h4 class="author">Sebastian Funk and James Azam</h4>



<p><em>epichains</em> provides methods to analyse and simulate the size and length of branching processes with an arbitrary offspring distribution.
In this vignette we lay out the mathematical concepts behind the functionality available
in the package.</p>
<div id="branching-processes" class="section level1">
<h1>Branching processes</h1>
<p><a href="https://en.wikipedia.org/wiki/Branching_process">Branching processes</a> are a class of models that are used to model the growth of populations. They assume that each member of the population produces a number of offspring, <span class="math inline">\(Z\)</span>, that is a random variable with probability mass function <span class="math inline">\(p(Z = z | \theta)\)</span>, called the <em>offspring distribution</em>.
Their use has a long history in epidemiology, where the population is interpreted as a pathogen, and the offspring as new hosts that it infects <span class="citation">(<a href="#ref-farrington2003">Farrington, Kanaan, and Gay 2003</a>)</span>.
Below we will call these infected individuals <em>cases</em> but the methods could be applied in other contexts where branching processes are to be used.</p>
</div>
<div id="simulation" class="section level1">
<h1>Simulation</h1>
<p>To simulate from a branching process, we start with a single case and proceed in discrete steps or generations, drawing from the offspring distribution <span class="math inline">\(p(Z=z | \theta)\)</span> to generate new cases from each case.</p>
<p>Given an infector <span class="math inline">\(i\)</span> and infectee <span class="math inline">\(j\)</span>, we can additionally assign them a distribution of times <span class="math inline">\(T\)</span> that approximates when the infection event occurred. If we define <span class="math inline">\(T\)</span> as a random variable with distribution <span class="math inline">\(f(T = t; \theta)\)</span> we can assign each case <span class="math inline">\(j\)</span> a time <span class="math inline">\(t_{j}\)</span> which, if case <span class="math inline">\(j\)</span> has been affected by case <span class="math inline">\(i\)</span> is given by <span class="math inline">\(f(t_{j} - t_{i} | \theta)\)</span>.
If we identify the timing of cases by the time of their symptom onset this is the <a href="https://en.wikipedia.org/wiki/Serial_interval">serial interval</a>, but depending on case definitions this could be another interval.</p>
<div id="summary-statistics" class="section level2">
<h2>Summary statistics</h2>
<p>Branching process simulations end when they have gone extinct, that is, no more offspring are being produced, or because of some stopping criterion. To summarise the simulations, we either study the <em>size</em> or <em>length</em> of the resulting <em>chain</em> of cases.
The size <span class="math inline">\(S\)</span> of a chain is the number of cases that have occurred over the course of the simulation including the initial case so that <span class="math inline">\(S \geq 1\)</span>.
The length <span class="math inline">\(L\)</span> of a chain is the number of generations that have been simulated including the initial case so that <span class="math inline">\(L \geq 1\)</span>.</p>
</div>
</div>
<div id="inference" class="section level1">
<h1>Inference</h1>
<p>By characterising a chains of cases by their size of length we can conduct inference to learn about the underlying parameters <span class="math inline">\(\theta\)</span> from observation of chain sizes or chain lengths <span class="citation">(<a href="#ref-blumberg2013">Blumberg and Lloyd-Smith 2013</a>)</span>.
In general this is only possible for <em>subcritical</em> branching processes, i.e. ones where the mean number of offspring is less than 1, as otherwise the branching process could grow forever.
However, we can expand the theory to <em>supercritical</em> branching processes, i.e. ones where the mean number of offspring is greater than 1, by defining a cut off of chain size or length beyond which we treat the chain as if it had infinite size or length, respectively.</p>
<div id="size-and-length-distributions-for-some-offspring-distributions" class="section level2">
<h2>Size and length distributions for some offspring distributions</h2>
<p>We show the equations for the size and length distributions for some offspring distributions where they can be derived analytically:
<a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson</a>,
<a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial</a>,
<a href="https://en.wikipedia.org/wiki/Geometric_distribution">geometric</a>,
and a <a href="https://en.wikipedia.org/wiki/Gamma_distribution">gamma</a>-<a href="https://en.wikipedia.org/wiki/Borel_distribution">Borel</a> mixture.</p>
<div id="negative-binomial-and-special-cases" class="section level3">
<h3>Negative binomial and special cases</h3>
<p>If the offspring distribution is a Poisson distribution, we can interpret its rate parameter <span class="math inline">\(\lambda\)</span> as the basic reproduction number <span class="math inline">\(R_{0}\)</span> of the pathogen.
In the more general case where the offspring definition can be <em>overdispersed</em> leading to <em>superspreading</em> we can use a negative binomial offspring distribution with mean <span class="math inline">\(\mu\)</span> and overdispersion <span class="math inline">\(k\)</span> <span class="citation">Blumberg and Lloyd-Smith (<a href="#ref-blumberg2013">2013</a>)</span>.
In that case, the mean parameter <span class="math inline">\(\mu\)</span> is interpreted as the basic reproduction number <span class="math inline">\(R_0\)</span> of the pathogen.
The negative binomial distribution arises from a Poisson-gamma mixture and thus a branching process with negative binomial distributed offspring can be interpreted as one with Poisson distributed offspring where the basic reproduction number <span class="math inline">\(R_0\)</span> itself varies according to a gamma distribution.
The amount of variation in <span class="math inline">\(R_0\)</span> is then interpreted as individual-level variation in transmission representing overdispersion or superspreading, and the degree to which this happens is given by the overdispersion parameter <span class="math inline">\(k\)</span>.</p>
<div id="size-distributions" class="section level4">
<h4>Size distributions</h4>
<p>The probability <span class="math inline">\(p\)</span> of a chain of size <span class="math inline">\(S\)</span> given <span class="math inline">\(R_0\)</span> and <span class="math inline">\(k\)</span> in a branching process with negative binomial offspring distribution is given in Eq. 9 of <span class="citation">Blumberg and Lloyd-Smith (<a href="#ref-blumberg2013">2013</a>)</span></p>
<p><span class="math display">\[
p(S|R_0, k) = \frac{\Gamma(kS + S - 1)}{\Gamma(kS)\Gamma(S + 1)} \frac{\left(\frac{R_0}{k}\right)^{S - 1}}{\left( 1 + \frac{R_0}{k} \right)^{kS + S - 1}}
\]</span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the gamma function.
In order to estimate <span class="math inline">\(S\)</span> from a given <span class="math inline">\(R_0\)</span> and <span class="math inline">\(k\)</span> we can define a likelihood function <span class="math inline">\(L(S) = p(S|R_0, k)\)</span>.
The corresponding log-likelihood is</p>
<p><span class="math display">\[\begin{align}
\mathrm{LL}(S) = &amp;\log\Gamma(kS + S  - 1) - \left(\log\Gamma(kS) + \log\Gamma(S - 1) \right) \\
&amp; + (S-1) \log \frac{R_0}{k} - (SR_0 + (S - 1)) \log \left(1 + \frac{R_0}{k}\right)
\end{align}\]</span></p>
<p>The log-likelihood for Poisson distributed offspring follows from this where <span class="math inline">\(k\)</span> tends to infinity (corresponding to Eq. 2.2 in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span>)</p>
<p><span class="math display">\[
\mathrm{LL}(S) = (S - 1) \log R_0 - S R_0 + (S - 2) \log S - \log\Gamma(S)
\]</span></p>
<p>In all cases the point estimate for the basic reproduction number <span class="math inline">\(\hat{R_0}\)</span> is related to the mean chain size <span class="math inline">\(\bar{S}\)</span> by</p>
<p><span class="math display">\[
\hat{R_0} = 1 - \frac{1}{\bar{S}}
\]</span></p>
</div>
<div id="length-distributions" class="section level4">
<h4>Length distributions</h4>
<p>The cumulative mass function <span class="math inline">\(F(L)\)</span> of observing a chain of length <span class="math inline">\(L\)</span> when offspring is Poisson distributed is given by Eq. (2.5) in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span> (there called “outbreak duration”):</p>
<p><span class="math display">\[
F(L) = e^{-R_0} E_L \left( e^{R_0 e^{-R_0} } \right)
\]</span></p>
<p>where <span class="math inline">\(E_L(x)\)</span> is the iterated exponential function, <span class="math inline">\(E_0(x) = 1\)</span>, <span class="math inline">\(E_{L + 1}(x) = x^{E_L(x)}\)</span>.</p>
<p>For geometric distributed offspring (corresponding to a negative Binomial with <span class="math inline">\(k=1\)</span>) this function is given by</p>
<p><span class="math display">\[
F(L) = \frac{ 1- R_0^{L + 1} } {1 - R_0^{L - 2}}
\]</span></p>
<p>In both cases <span class="math inline">\(f(L)\)</span> denotes cumulative mass functions and therefore the probability of observing a chain of length <span class="math inline">\(L\)</span> is therefore <span class="math inline">\(f(L) - f(L - 1)\)</span>.</p>
</div>
</div>
<div id="gamma-borel-mixture" class="section level3">
<h3>Gamma-Borel mixture</h3>
<p>The probability distribution of outbreak sizes from a branching process with a Poisson offspring distribution (Eq. 2.2 in <span class="citation">Farrington, Kanaan, and Gay (<a href="#ref-farrington2003">2003</a>)</span>) is a special case of the <a href="https://en.wikipedia.org/wiki/Borel_distribution#Borel%E2%80%93Tanner_distribution">Borel-Tanner distribution</a> starting with 1 individual.
An alternative to the negative binomial offspring distribution which represents a Poisson-gamma mixture is a Borel-gamma mixture.
This could represent situations where the variation is not at the <em>individual level</em> but at the <em>chain level</em>, i.e. transmission chains is homogeneous but there is heterogeneity between chains.
In that case, it can be shown that the resulting log-likelihood of chain sizes is</p>
<p><span class="math display">\[\begin{align}
\mathrm{LL}(S) = &amp;\log\Gamma(k + S - 1) - \left(\log\Gamma(k) + \log\Gamma(S + 1) \right) \\
&amp; + (S-1) \log S - k \log \left(S + \frac{R_0}{k}\right)
\end{align}\]</span></p>
</div>
</div>
<div id="numerical-approximations-of-chain-size-and-length-distributions" class="section level2">
<h2>Numerical approximations of chain size and length distributions</h2>
<p>When analytic likelihoods are not available a numerical approximation is used to derive the distributions.
In order to do this, the simulation functionality is be used to generate <span class="math inline">\(n\)</span> simulated chains and the value of the cumulative mass function <span class="math inline">\(P(S|\theta)\)</span> at the observed <span class="math inline">\(S\)</span> approximated by the empirical cumulative distribution function:
<span class="math display">\[
P(S|\theta) \approx \sum_i \mathbf{1}(x_i &lt;= S)
\]</span>
where <span class="math inline">\(\mathbf{1}\)</span> is the indicator function and <span class="math inline">\(x_i\)</span> the i-th observed chain size (or length, if the interest is in <span class="math inline">\(L\)</span>).
In order to improve this approximation a linear approximation is applied to the values of the empirical distribution function (at the expense of normalisation to 1).</p>
<p>The (unnormalised) probability of observing <span class="math inline">\(S\)</span> is then given by
<span class="math display">\[
p(S|\theta) = P(S|\theta) - P(S - 1|\theta)
\]</span>
and a an equivalent relationship is used for <span class="math inline">\(L\)</span>.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-blumberg2013" class="csl-entry">
Blumberg, S., and J. O. Lloyd-Smith. 2013. <span>“Comparing Methods for Estimating R0 from the Size Distribution of Subcritical Transmission Chains.”</span> <em>Epidemics</em> 5 (3): 131–45. <a href="https://doi.org/10.1016/j.epidem.2013.05.002">https://doi.org/10.1016/j.epidem.2013.05.002</a>.
</div>
<div id="ref-farrington2003" class="csl-entry">
Farrington, C. P., M. N. Kanaan, and N. J. Gay. 2003. <span>“Branching Process Models for Surveillance of Infectious Diseases Controlled by Mass Vaccination.”</span> <em>Biostatistics (Oxford, England)</em> 4 (2): 279–95. <a href="https://doi.org/10.1093/biostatistics/4.2.279">https://doi.org/10.1093/biostatistics/4.2.279</a>.
</div>
<div id="ref-lloyd-smith2005" class="csl-entry">
Lloyd-Smith, J. O., S. J. Schreiber, P. E. Kopp, and W. M. Getz. 2005. <span>“Superspreading and the Effect of Individual Variation on Disease Emergence.”</span> <em>Nature</em> 438 (7066): 355–59. <a href="https://doi.org/10.1038/nature04153">https://doi.org/10.1038/nature04153</a>.
</div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
